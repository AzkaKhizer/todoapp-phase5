# =============================================================================
# Continuous Deployment Workflow
# =============================================================================
# Triggered on:
# - Push to main branch (after CI passes)
# - Manual trigger with environment selection
#
# Deploys to:
# - dev: Automatic on main push
# - staging: Manual trigger
# - prod: Manual trigger with approval
# =============================================================================

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: "Skip tests before deployment"
        required: false
        default: false
        type: boolean

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP || 'todoapp-dev-rg' }}
  AKS_CLUSTER_NAME: ${{ vars.AKS_CLUSTER_NAME || 'todoapp-dev-aks' }}
  ACR_NAME: ${{ vars.ACR_NAME || 'todoappdevacr' }}
  NAMESPACE: "todo-app"

concurrency:
  group: cd-${{ github.ref }}-${{ inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Determine Environment
  # ===========================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Generate image tag
        id: tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "tag=${SHORT_SHA}-${TIMESTAMP}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Run Tests (unless skipped)
  # ===========================================================================
  test:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ inputs.skip_tests != true }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Run backend tests
        working-directory: backend
        run: |
          uv venv
          uv pip install -e ".[dev]"
          source .venv/bin/activate
          pytest tests/unit -v --tb=short
        env:
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          BETTER_AUTH_SECRET: "test-secret"

  # ===========================================================================
  # Build and Push Images
  # ===========================================================================
  build:
    name: Build Images
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      backend_image: ${{ steps.build.outputs.backend_image }}
      frontend_image: ${{ steps.build.outputs.frontend_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/todo-backend:${{ needs.setup.outputs.image_tag }}
            ${{ env.ACR_NAME }}.azurecr.io/todo-backend:latest
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/todo-backend:cache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/todo-backend:cache,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/todo-frontend:${{ needs.setup.outputs.image_tag }}
            ${{ env.ACR_NAME }}.azurecr.io/todo-frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.API_URL || 'https://api.todoapp.example.com' }}
            NEXT_PUBLIC_WS_URL=${{ vars.WS_URL || 'wss://api.todoapp.example.com' }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/todo-frontend:cache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/todo-frontend:cache,mode=max

      - name: Output image names
        id: build
        run: |
          echo "backend_image=${{ env.ACR_NAME }}.azurecr.io/todo-backend:${{ needs.setup.outputs.image_tag }}" >> $GITHUB_OUTPUT
          echo "frontend_image=${{ env.ACR_NAME }}.azurecr.io/todo-frontend:${{ needs.setup.outputs.image_tag }}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Deploy to Environment
  # ===========================================================================
  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, build]
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy backend
        run: |
          helm upgrade --install todo-backend \
            ./infrastructure/helm/todo-backend-v2 \
            --namespace ${{ env.NAMESPACE }} \
            --create-namespace \
            --set image.repository=${{ env.ACR_NAME }}.azurecr.io/todo-backend \
            --set image.tag=${{ needs.setup.outputs.image_tag }} \
            --set env.ENVIRONMENT=${{ needs.setup.outputs.environment }} \
            --values ./infrastructure/helm/todo-backend-v2/values-azure.yaml \
            --wait \
            --timeout 10m

      - name: Deploy frontend
        run: |
          helm upgrade --install todo-frontend \
            ./infrastructure/helm/todo-frontend-v2 \
            --namespace ${{ env.NAMESPACE }} \
            --set image.repository=${{ env.ACR_NAME }}.azurecr.io/todo-frontend \
            --set image.tag=${{ needs.setup.outputs.image_tag }} \
            --values ./infrastructure/helm/todo-frontend-v2/values-azure.yaml \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          echo "Checking deployment status..."
          kubectl rollout status deployment/todo-backend -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/todo-frontend -n ${{ env.NAMESPACE }} --timeout=5m

          echo "Running smoke tests..."
          BACKEND_POD=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=todo-backend -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.NAMESPACE }} $BACKEND_POD -- curl -sf http://localhost:8000/api/health || exit 1

          echo "Deployment verified successfully!"

  # ===========================================================================
  # Rollback on Failure
  # ===========================================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: failure() && needs.deploy.result == 'failure'

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Rollback backend
        run: |
          echo "Rolling back backend deployment..."
          helm rollback todo-backend -n ${{ env.NAMESPACE }} || true

      - name: Rollback frontend
        run: |
          echo "Rolling back frontend deployment..."
          helm rollback todo-frontend -n ${{ env.NAMESPACE }} || true

      - name: Notify on rollback
        if: always()
        run: |
          echo "::error::Deployment failed and was rolled back!"

  # ===========================================================================
  # Post-Deployment Notification
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always()

    steps:
      - name: Deployment succeeded
        if: needs.deploy.result == 'success'
        run: |
          echo "::notice::Successfully deployed to ${{ needs.setup.outputs.environment }}"
          echo "Image tag: ${{ needs.setup.outputs.image_tag }}"

      - name: Deployment failed
        if: needs.deploy.result == 'failure'
        run: |
          echo "::error::Deployment to ${{ needs.setup.outputs.environment }} failed"
